<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Calendario Hot 3.0 🔥</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
  <div class="container">
    <h1>Calendario Hot 3.0 🔥</h1>

    <div class="form">
      <label for="date">Data:</label>
      <input type="date" id="date">

      <label for="event">Evento:</label>
      <select id="event">
        <option value="sega">🖐️ Ho fatto una sega</option>
        <option value="ditalino">👩‍🦰 Lei ha fatto un ditalino</option>
        <option value="scopata">🍑 Abbiamo scopato</option>
        <option value="preliminari">🛁 Preliminari</option>
      </select>

      <label for="note">Note:</label>
      <input type="text" id="note" placeholder="Scrivi una nota (opzionale)">

      <button onclick="saveEvent()">Salva evento</button>
    </div>

    <h2>Storico eventi</h2>
    <ul id="eventsList"></ul>

    <h2>Statistiche</h2>
    <div id="stats">
      <p>🖐️ Seghe: <span id="segaCount">0</span></p>
      <p>👩‍🦰 Ditalini: <span id="ditalinoCount">0</span></p>
      <p>🍑 Scopate: <span id="scopataCount">0</span></p>
      <p>🛁 Preliminari: <span id="preliminariCount">0</span></p>
    </div>

    <canvas id="chart" width="400" height="400"></canvas>

    <div id="badgeContainer" class="hidden">
      🎖️ <h3 id="badgeMessage"></h3>
    </div>
  </div>

<script>
  // ✅ 1. CONFIGURA SUPABASE
  const supabaseUrl = 'https://cdffrolmhlhbmmskkzav.supabase.co'; // <-- metti il tuo URL SUPABASE
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNkZmZyb2xtaGxoYm1tc2tremF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU2OTM4NDksImV4cCI6MjA2MTI2OTg0OX0.MORzdf26QDCuEhUelB6mDISM2bNRSUmPMl_S5P14QJc'; // <-- metti qui la chiave anon/public
  const supabase = createClient(supabaseUrl, supabaseKey); // Correzione: utilizza la funzione createClient correttamente

  // ✅ 2. VARIABILI
  let stats = {
    sega: 0,
    ditalino: 0,
    scopata: 0,
    preliminari: 0
  };
  let eventsArray = [];

  // ✅ 3. FUNZIONE SALVA EVENTO
  async function saveEvent() {
    const date = document.getElementById('date').value;
    const eventType = document.getElementById('event').value;
    const note = document.getElementById('note').value;

    if (!date || !eventType) {
      alert('Compila tutti i campi!');
      return;
    }

    const eventTextMap = {
      sega: '🖐️ Ho fatto una sega',
      ditalino: '👩‍🦰 Lei ha fatto un ditalino',
      scopata: '🍑 Abbiamo scopato',
      preliminari: '🛁 Preliminari'
    };

    const { data, error } = await supabase
      .from('events')
      .insert([{
        date, 
        eventType, 
        note 
      }]);

    if (error) {
      alert('Errore nel salvataggio!');
      console.error(error);
    } else {
      alert('Evento salvato!');
      fetchEvents();
    }
  }

  // ✅ 4. FUNZIONE PRENDI EVENTI
  async function fetchEvents() {
    const { data, error } = await supabase
      .from('events')
      .select('*')
      .order('date', { ascending: false });

    if (error) {
      console.error(error);
      return;
    }

    eventsArray = data;
    renderEvents();
    updateStats();
    updateChart();
    checkBadges();
  }

  // ✅ 5. RENDERIZZA EVENTI
  function renderEvents() {
    const eventsList = document.getElementById('eventsList');
    eventsList.innerHTML = '';

    eventsArray.forEach(event => {
      const li = document.createElement('li');
      const emojiMap = {
        sega: '🖐️',
        ditalino: '👩‍🦰',
        scopata: '🍑',
        preliminari: '🛁'
      };
      li.innerHTML = `${event.date} - ${emojiMap[event.eventType]} ${event.eventType} ${event.note ? `- Nota: ${event.note}` : ''}`;
      eventsList.appendChild(li);
    });
  }

  // ✅ 6. AGGIORNA STATISTICHE
  function updateStats() {
    stats = { sega: 0, ditalino: 0, scopata: 0, preliminari: 0 };
    eventsArray.forEach(event => {
      stats[event.eventType]++;
    });
    document.getElementById('segaCount').textContent = stats.sega;
    document.getElementById('ditalinoCount').textContent = stats.ditalino;
    document.getElementById('scopataCount').textContent = stats.scopata;
    document.getElementById('preliminariCount').textContent = stats.preliminari;
  }

  // ✅ 7. CREA E AGGIORNA GRAFICO
  let chart;
  function createChart() {
    const ctx = document.getElementById('chart').getContext('2d');
    chart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: ['Seghe', 'Ditalini', 'Scopate', 'Preliminari'],
        datasets: [{
          data: [0, 0, 0, 0],
          backgroundColor: ['#ff9999', '#ff66b2', '#ff33cc', '#ffccff']
        }]
      }
    });
  }

  function updateChart() {
    if (chart) {
      chart.data.datasets[0].data = [
        stats.sega,
        stats.ditalino,
        stats.scopata,
        stats.preliminari
      ];
      chart.update();
    }
  }

  // ✅ 8. CONTROLLA PREMI
  function checkBadges() {
    const badgeContainer = document.getElementById('badgeContainer');
    const badgeMessage = document.getElementById('badgeMessage');
    badgeContainer.classList.add('hidden');

    if (stats.sega >= 10 && stats.sega % 10 === 0) {
      badgeContainer.classList.remove('hidden');
      badgeMessage.textContent = `🖐️ ${stats.sega} Seghe fatte!`;
      setTimeout(() => badgeContainer.classList.add('hidden'), 3600000);
    } else if (stats.ditalino >= 5 && stats.ditalino % 5 === 0) {
      badgeContainer.classList.remove('hidden');
      badgeMessage.textContent = `👩‍🦰 ${stats.ditalino} Ditalini fatti!`;
      setTimeout(() => badgeContainer.classList.add('hidden'), 3600000);
    } else if (stats.scopata >= 3 && stats.scopata % 3 === 0) {
      badgeContainer.classList.remove('hidden');
      badgeMessage.textContent = `🍑 ${stats.scopata} Scopate fatte!`;
      setTimeout(() => badgeContainer.classList.add('hidden'), 3600000);
    } else if (stats.preliminari >= 5 && stats.preliminari % 5 === 0) {
      badgeContainer.classList.remove('hidden');
      badgeMessage.textContent = `🛁 ${stats.preliminari} Preliminari completati!`;
      setTimeout(() => badgeContainer.classList.add('hidden'), 3600000);
    }
  }

  // ✅ 9. AL CARICAMENTO
  window.onload = async () => {
    createChart();
    await fetchEvents();
  };
</script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</body>
</html>
